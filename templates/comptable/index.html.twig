<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Application Comptable - Moonlight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/fontAwesome.css') }}">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/templatemo-main.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22></text></svg>">
    
    <style>
        .cloture-form-wrapper { background: rgba(0, 0, 0, 0.2); padding: 30px; border-radius: 8px; color: #fff; }
        .cloture-form-group { margin-bottom: 25px; }
        .cloture-input, .cloture-textarea { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; }
        .cloture-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        .cloture-table th, .cloture-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); vertical-align: top; }
        .cloture-table th { text-transform: uppercase; font-size: 12px; color: #ccc; }
        .cloture-table td.numeric { text-align: right; }
        .cloture-table .ecart { font-weight: bold; }
        .cloture-submit-btn { background: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; }
        .cloture-submit-btn:hover { background: #2ecc71; }
        
        /* Détails historiques */
        .details-row { display: none; background: rgba(255,255,255,0.8); }
        .details-row td { padding: 10px; }
        .toggle-btn { cursor: pointer; color: #007bff; text-decoration: underline; }

        /* === NOUVEAUX STYLES POUR LE BILLETAGE === */
        .billetage-container { padding-top: 10px; }
        .billet-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px; /* Espace entre les lignes */
        }
        .billet-row .billet-label {
            width: 130px; /* Largeur fixe pour l'étiquette */
            text-align: right;
            padding-right: 5px;
        }
        .billet-row .billet-count {
            width: 80px; /* Largeur de l'input */
            text-align: center;
            padding: 5px; /* Moins de padding pour un look compact */
        }
        .billet-row .billet-equals {
            margin: 0 10px;
        }
        .billet-row .billet-subtotal {
            font-weight: bold;
            min-width: 120px; /* Espace pour afficher le sous-total */
            text-align: right;
        }
        /* ======================================= */

    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="#1"><i class="fa fa-home"></i> <em>Tableau de bord</em></a></li>
            <li><a href="#2"><i class="fa fa-calculator"></i> <em>Arrêt de Caisse</em></a></li>
            <li><a href="#3"><i class="fa fa-history"></i> <em>Historique</em></a></li>
            <li><a href="#4"><i class="fa fa-cog"></i> <em>Gestion</em></a></li>
        </ul>
    </nav>

    <div class="slides">
        <!-- Slide 1 -->
        <div class="slide" id="1">
            <div class="content first-content">
                <div class="container-fluid">
                    <div class="col-md-3"><img src="{{ asset('utils/images_moon/calculator3.png') }}" alt="Comptable"></div>
                    <div class="col-md-9">
                        <h2>Arrêt de Caisse</h2>
                        {% for message in app.flashes('success') %}
                            <div style="background: #27ae60; color: white; padding: 15px; border-radius: 5px; margin-top: 20px;">
                                {{ message }}
                            </div>
                        {% endfor %}
                        {% if hasPaymentsToClose %}
                            <div class="main-btn" style="margin-top: 20px;"><a href="#2">Démarrer l'Arrêt de Caisse</a></div>
                        {% else %}
                            <div style="background: rgba(40, 167, 69, 0.8); color: white; padding: 15px; border-radius: 5px;">
                                <strong>Caisse à jour !</strong> Aucun paiement en attente de clôture.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 2 -->
        <div class="slide" id="2">
            <div class="content third-content">
                <div class="container-fluid">
                    <h2>Procédure d'Arrêt de Caisse</h2>
                    {% if totals is not empty %}
                        <form id="cloture-caisse-form" action="{{ path('app_comptable_arret_de_caisse_submit') }}" method="post">
                            <div class="cloture-form-wrapper">
                                <!--<div class="cloture-form-group">
                                    <label for="fond_de_caisse_initial">Fond de caisse initial (si applicable)</label>
                                    <input type="number" step="0.01" id="fond_de_caisse_initial" name="fond_de_caisse_initial" class="cloture-input" value="0" required>
                                </div>-->

                                <table class="cloture-table">
                                    <thead>
                                        <tr><th>Méthode de Paiement</th><th class="numeric">Total Théorique</th><th>Détail Compté</th><th class="numeric">Écart</th></tr>
                                    </thead>
                                    <tbody>
                                    {% for referencePaiement, theorique in totals %}
                                        <tr>
                                            <td><strong>{{ referencePaiement }}</strong></td>
                                            <td class="numeric" data-theorique="{{ theorique }}">{{ theorique|number_format(0, ',', ' ') }} MGA</td>
                                            <td>
                                                {% if referencePaiement == 'Espèces' %}
                                                    {# === NOUVELLE STRUCTURE POUR LE BILLETAGE === #}
                                                    <div class="billetage-container">
                                                        {% for valeur in [20000, 10000, 5000, 2000, 1000, 500, 200, 100] %}
                                                            <div class="billet-row">
                                                                <span class="billet-label">{{ valeur|number_format(0, ',', ' ') }} MGA x </span>
                                                                <input type="number" name="billet_{{ valeur }}" value="0" class="cloture-input billet-count" min="0" data-valeur="{{ valeur }}">
                                                                <span class="billet-equals"> = </span>
                                                                <span class="billet-subtotal">0 MGA</span>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <input type="number" step="0.01" class="cloture-input amount-counted" name="compte_{{ referencePaiement|lower|replace({' ': '_'}) }}" value="0" required>
                                                {% endif %}
                                            </td>
                                            <td class="numeric ecart">0 MGA</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr style="font-size: 1.2em; background: rgba(0,0,0,0.2);">
                                            <th>Total</th>
                                            <th id="total-theorique" class="numeric">0 MGA</th>
                                            <th id="total-compte" class="numeric">0 MGA</th>
                                            <th id="total-ecart" class="numeric">0 MGA</th>
                                        </tr>
                                    </tfoot>
                                </table>

                                <div class="cloture-form-group" style="margin-top: 30px;">
                                    <label for="notes">Notes sur la clôture (optionnel)</label>
                                    <textarea id="notes" name="notes" class="cloture-textarea" rows="3" placeholder="Ex: écart dû à un rendu de monnaie, etc."></textarea>
                                </div>
                                <button type="submit" class="cloture-submit-btn">Valider et Clôturer la Caisse</button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-info">Aucun paiement à clôturer pour le moment.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Slide 3 (Historique) -->
        <div class="slide" id="3">
             <div class="content fourth-content">
                <div class="container-fluid">
                    <h2 style="color: #fff">Historique des 10 dernières clôtures</h2>
                    <table class="table table-hover">
                        <thead>
                            <tr style="background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">ID</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Date</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Utilisateur</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Écart Espèces</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for cloture in pastClotures %}
                            <tr style="background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                                <td style="padding: 12px; border: none;">#{{ cloture.id }}</td>
                                <td style="padding: 12px; border: none;">{{ cloture.dateCloture|date('d/m/Y H:i') }}</td>
                                <td style="padding: 12px; border: none;">{{ cloture.utilisateur.userIdentifier }}</td>
                                {% set ecartEspeces = cloture.detailsPaiements['Espèces'].ecart|default(0) %}
                                <td style="padding: 12px; border: none;" 
                                    class="{% if ecartEspeces < 0 %}text-danger{% elseif ecartEspeces > 0 %}text-warning{% else %}text-success{% endif %}">
                                    {{ ecartEspeces|number_format(0, ',', ' ') }} MGA
                                </td>
                                <td style="padding: 12px; border: none;">
                                    <span class="toggle-btn" 
                                        data-id="{{ cloture.id }}" 
                                        style="cursor:pointer; color:#007bff; font-weight:500;">
                                        Voir détails
                                    </span>
                                </td>
                            </tr>
                            <tr class="details-row" id="details-{{ cloture.id }}">
                                <td colspan="5">
                                    <div style="padding: 15px;">
                                        <h5>Détails de la clôture #{{ cloture.id }}</h5>
                                        <!-- <p><strong>Fond de caisse initial :</strong> {{ cloture.fondDeCaisseInitial|number_format(0, ',', ' ') }} MGA</p> -->
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr style="background: #eee;"><th>Méthode</th><th>Théorique</th><th>Compté</th><th>Écart</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for methode, data in cloture.detailsPaiements %} 
                                                <tr>
                                                    <td><strong>{{ methode }}</strong></td>
                                                    <td>{{ data.theorique|number_format(0, ',', ' ') }} MGA</td>
                                                    <td>{{ data.compte|number_format(0, ',', ' ') }} MGA</td>
                                                    <td>{{ data.ecart|number_format(0, ',', ' ') }} MGA</td>
                                                </tr>
                                                {% if methode == 'Espèces' and data.billetage is defined %}
                                                    <tr>
                                                        <td colspan="4" style="padding-left: 30px;">
                                                            <em>Détail du billetage compté :</em><br>
                                                            {% for val, qte in data.billetage|sort((a, b) => b <=> a) %}
                                                                &bull; {{ val|number_format(0, ',', ' ') }} MGA x {{ qte }} = {{ (val * qte)|number_format(0, ',', ' ') }} MGA<br>
                                                            {% endfor %}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                        {% if cloture.notes %}
                                            <p><strong>Notes :</strong> {{ cloture.notes|nl2br }}</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="5">Aucun historique de clôture.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Slide 4 -->
        <div class="slide" id="4">
            <div class="content fifth-content">
                <div class="container-fluid">
                    <!-- Titre principal -->
                    <h2 style="color: #fff; margin-bottom: 25px;">Gestion</h2>

                    <!-- Container en 2 colonnes -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                        <!-- Colonne 1 : Profil utilisateur -->
                        <div style="background: rgba(255,255,255,0.05); border-radius:12px; 
                                    box-shadow:0 2px 8px rgba(0,0,0,0.2); padding:20px; margin-left:20px;">
                            <h4 style="color:#fff; margin-bottom:15px;">Profil Utilisateur</h4>
                            <p style="color:#fff; margin-bottom:10px;">
                                <strong>Nom :</strong> {{ app.user.userIdentifier }}
                            </p>
                            <p style="color:#fff; margin-bottom:10px;">
                                <strong>Rôle :</strong>
                                {% if 'ROLE_COMPTABLE' in app.user.roles %}
                                    Comptable
                                {% else %}
                                    {{ app.user.roles|join(', ') }}
                                {% endif %}
                            </p>
                        </div>

                        <!-- Colonne 2 : Instructions -->
                        <div style="background: rgba(255,255,255,0.05); border-radius:12px; 
                                    padding:20px; margin-right:20px;">
                            <h4 style="color:#fff; margin-bottom:15px;">Instructions</h4>
                            <ul style="color:#fff; line-height:1.8;">
                                <p>Consultez vos informations de profil (nom, rôle).</p>
                                <p>Utilisez la barre de navigation pour accéder aux autres sections.</p>
                                <p>Vérifiez vos permissions selon votre rôle.</p>
                                <p>Déconnectez-vous en cliquant sur le bouton ci-dessous.</p>
                            </ul>
                        </div>
                    </div>

                    <!-- Bouton Déconnexion (centré sous les colonnes) -->
                    <div style="margin-top:30px; text-align:center;">
                        <a href="{{ path('app_logout') }}" class="btn-gradient" 
                        style="color: #fff; padding:12px 25px; border-radius:8px; text-decoration:none;">
                            <i class="fa fa-sign-out"></i> Déconnexion
                        </a>
                    </div>
                </div>
            </div>
        </div>


    </div>

    {# On inclut jQuery car main.js en dépendait probablement #}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="{{ asset('utils/js_moon/main.js') }}"></script>

    {# === SCRIPT JAVASCRIPT MIS À JOUR === #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR').format(value) + ' MGA';
        }

        function updateAllEcarts() {
            const fondInitial = parseFloat(document.getElementById('fond_de_caisse_initial')?.value) || 0;
            let totalTheo = 0, totalCompte = 0, totalEcart = 0;

            document.querySelectorAll('.cloture-table tbody tr').forEach(row => {
                const theoEl = row.querySelector('[data-theorique]');
                if (!theoEl) return;

                const theo = parseFloat(theoEl.dataset.theorique);
                const ref = row.querySelector('td strong').textContent.trim();
                let compte = 0;

                if (ref === 'Espèces') {
                    // Boucle sur chaque ligne de billet
                    row.querySelectorAll('.billet-row').forEach(billetRow => {
                        const input = billetRow.querySelector('.billet-count');
                        const qte = parseInt(input.value) || 0;
                        const valeur = parseInt(input.dataset.valeur); // On utilise notre data-attribut
                        
                        const subtotal = qte * valeur;
                        
                        // Mise à jour du sous-total de la ligne
                        billetRow.querySelector('.billet-subtotal').textContent = formatCurrency(subtotal);
                        
                        compte += subtotal; // On ajoute au total compté pour les espèces
                    });
                } else {
                    compte = parseFloat(row.querySelector('.amount-counted').value) || 0;
                }

                const ecart = ref === 'Espèces' ? compte - (theo + fondInitial) : compte - theo;
                row.querySelector('.ecart').textContent = formatCurrency(ecart);

                totalTheo += theo;
                totalCompte += compte;
                totalEcart += ecart;
            });

            document.getElementById('total-theorique').textContent = formatCurrency(totalTheo);
            document.getElementById('total-compte').textContent = formatCurrency(totalCompte);
            document.getElementById('total-ecart').textContent = formatCurrency(totalEcart);
        }

        document.body.addEventListener('input', e => {
            if (e.target.classList.contains('amount-counted') || e.target.classList.contains('billet-count') || e.target.id === 'fond_de_caisse_initial') {
                updateAllEcarts();
            }
        });

        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const row = document.getElementById('details-' + btn.dataset.id);
                row.style.display = row.style.display === 'table-row' ? 'none' : 'table-row';
            });
        });
        
        // Lancer un premier calcul au chargement de la page
        updateAllEcarts();
    });
    </script>
</body>
</html>