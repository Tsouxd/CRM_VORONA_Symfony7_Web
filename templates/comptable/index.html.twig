<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Application Comptable - Moonlight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/fontAwesome.css') }}">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/templatemo-main.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22></text></svg>">
    
    <style>
        .cloture-form-wrapper { background: rgba(0, 0, 0, 0.2); padding: 30px; border-radius: 8px; color: #fff; }
        .cloture-form-group { margin-bottom: 25px; }
        .cloture-input, .cloture-textarea { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff; }
        .cloture-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        .cloture-table th, .cloture-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); vertical-align: top; }
        .cloture-table th { text-transform: uppercase; font-size: 12px; color: #ccc; }
        .cloture-table td.numeric { text-align: right; }
        .cloture-table .ecart { font-weight: bold; }
        .cloture-submit-btn { background: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; }
        .cloture-submit-btn:hover { background: #2ecc71; }
        
        /* Détails historiques */
        .details-row { display: none; background: rgba(255,255,255,0.8); }
        .details-row td { padding: 10px; }
        .toggle-btn { cursor: pointer; color: #007bff; text-decoration: underline; }

        /* === NOUVEAUX STYLES POUR LE BILLETAGE === */
        .billetage-container { padding-top: 10px; }
        .billet-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px; /* Espace entre les lignes */
        }
        .billet-row .billet-label {
            width: 130px; /* Largeur fixe pour l'étiquette */
            text-align: right;
            padding-right: 5px;
        }
        .billet-row .billet-count {
            width: 80px; /* Largeur de l'input */
            text-align: center;
            padding: 5px; /* Moins de padding pour un look compact */
        }
        .billet-row .billet-equals {
            margin: 0 10px;
        }
        .billet-row .billet-subtotal {
            font-weight: bold;
            min-width: 120px; /* Espace pour afficher le sous-total */
            text-align: right;
        }
        /* ======================================= */
        /* NOUVEAUX STYLES POUR LE DASHBOARD COMPTABLE */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 8px;
            color: #fff;
            margin-bottom: 20px;
        }
        .dashboard-card .card-title {
            text-transform: uppercase;
            font-size: 14px;
            color: #ccc;
        }
        .dashboard-card .card-text {
            font-size: 2em;
            font-weight: bold;
        }
        .compta-table {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden; /* Pour que le radius s'applique aux coins du thead */
        }
        .compta-table table {
            width: 100%;
            border-collapse: collapse;
            color: #fff;
        }
        .compta-table th, .compta-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .compta-table th {
            background: rgba(0,0,0,0.3);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
        }
        .compta-table tbody tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .compta-table .badge { padding: 5px 10px; border-radius: 12px; font-size: 11px; }
        .compta-table .btn-group .btn { 
            padding: 4px 8px; 
            font-size: 12px; 
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            margin-left: 2px;
        }
        .compta-table .btn-group .btn:hover { background: rgba(255,255,255,0.2); }
        .filter-form { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .filter-form label { color: #ccc; }
        .filter-form .form-control, .filter-form .form-select {
            background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2);
        }
        .filter-form .form-control::placeholder { color: #aaa; }
        .filter-form option { background: #333; }

    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="#1"><i class="fa fa-home"></i> <em>Suivi Commandes</em></a></li>
            <li><a href="#2"><i class="fa fa-calculator"></i> <em>Arrêt de Caisse</em></a></li>
            <li><a href="#3"><i class="fa fa-history"></i> <em>Historique</em></a></li>
            <li><a href="#4"><i class="fa fa-cog"></i> <em>Gestion</em></a></li>
        </ul>
    </nav>

    <div class="slides">
        <!-- Slide 1: NOUVEAU Tableau de Bord Comptable -->
        <div class="slide" id="1">
            <div class="content second-content">
                <div class="container-fluid">
                    <h2 style="color: #fff;">Commandes — Comptabilité</h2>
                    
                    {% for type, messages in app.flashes %}
                        {% for message in messages %}
                            <div class="alert alert-{{ type }}">{{ message }}</div>
                        {% endfor %}
                    {% endfor %}

                    <!-- Bandeau de synthèse -->
                    <div class="row">
                        <div class="col-md-3"><div class="dashboard-card"><h5 class="card-title">Total à Payer</h5><p class="card-text">{{ synthese.totalAPayer|number_format(0, ',', ' ') }}</p></div></div>
                        <div class="col-md-3"><div class="dashboard-card"><h5 class="card-title">Montants Payés</h5><p class="card-text">{{ synthese.totalPaye|number_format(0, ',', ' ') }}</p></div></div>
                        <div class="col-md-3"><div class="dashboard-card"><h5 class="card-title">Reste Global</h5><p class="card-text">{{ synthese.resteGlobal|number_format(0, ',', ' ') }}</p></div></div>
                    </div>

                    <!-- Filtres -->
                    <div class="filter-form">
                        <form method="get" action="{{ path('app_comptable_dashboard') }}" class="row g-3 align-items-end">
                             <div class="col-md-2" style="padding-top: 30px;">
                                <div class="form-check">
                                    <input type="checkbox" name="non_solde" id="non_solde" value="1" class="form-check-input" {{ filters.non_solde ? 'checked' }}>
                                    <label for="non_solde" class="form-check-label">Reste > 0</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary">Filtrer</button>
                                <a href="{{ path('app_comptable_dashboard') }}" class="btn btn-secondary">Reset</a>
                            </div>
                        </form>
                    </div>

                    <!-- Liste des commandes -->
                    <div class="compta-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th><th>Client</th><th>Total</th><th>Payé</th><th>Reste</th><th>Statut</th><th>Vérifié</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in commandes %}
                                    {% set cmd = data.commande %}
                                    {% set reste = data.resteAPayer %}
                                    {% set montantPaye = data.montantPaye %}

                                    {# ============================================================= #}
                                    {# == NOUVELLE LOGIQUE DE CALCUL DU STATUT POUR L'AFFICHAGE == #}
                                    {# ============================================================= #}
                                    
                                    {# On définit le statut à afficher en suivant les règles métier #}
                                    {% set statutAffiche = 'EN_ATTENTE' %} {# Valeur par défaut si rien n'est payé #}

                                    {% if montantPaye > 0 and reste > 0 %}
                                        {% set statutAffiche = 'PARTIEL' %}
                                    {% elseif reste <= 0 %}
                                        {% set statutAffiche = 'PAYE' %}
                                    {% endif %}

                                    {# Le statut RECOUVREMENT est prioritaire sur les statuts calculés #}
                                    {% if cmd.statutComptable == 'RECOUVREMENT' %}
                                        {% set statutAffiche = 'RECOUVREMENT' %}
                                    {% endif %}
                                    
                                    {# ------------------------------------------------------------- #}

                                    {% set statut_badge = {
                                        'EN_ATTENTE': 'secondary', 
                                        'PARTIEL': 'warning', 
                                        'PAYE': 'success', 
                                        'RECOUVREMENT': 'danger'
                                    } %}

                                    <tr>
                                        <td>{{ cmd.dateCommande|date('d/m/Y') }}</td>
                                        <td>{{ cmd.client.nom }}</td>
                                        <td>{{ data.totalCommande|number_format(0, ',', ' ') }}</td>
                                        <td>{{ montantPaye|number_format(0, ',', ' ') }}</td>
                                        <td class="font-weight-bold">{{ reste|number_format(0, ',', ' ') }}</td>
                                        
                                        {# On utilise notre nouvelle variable `statutAffiche` #}
                                        <td><span class="badge bg-{{ statut_badge[statutAffiche] }}">{{ statutAffiche|replace({'_': ' '}) }}</span></td>
                                        
                                        <td>{{ (cmd.isVerifieComptable ?? false) ? 'Oui' : 'Non' }}</td>

                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ path('app_comptable_commande_detail', {id: cmd.id}) }}" class="btn">Détail</a>
                                                
                                                <form method="post" action="{{ path('app_comptable_commande_verifier', {id: cmd.id}) }}" onsubmit="return confirm('Vérifier cette commande ?');" class="d-inline">
                                                    <button type="submit" class="btn" {% if cmd.isVerifieComptable %}disabled{% endif %}>Vérifier</button>
                                                </form>

                                                {% if reste > 0 %}
                                                    <form method="post" action="{{ path('app_comptable_commande_recouvrement', {id: cmd.id}) }}" class="d-inline">
                                                        {# On utilise `statutAffiche` pour la condition disabled #}
                                                        <button type="submit" class="btn" {% if statutAffiche == 'RECOUVREMENT' %}disabled{% endif %}>Recouvrement</button>
                                                    </form>
                                                {% endif %}
                                                
                                                {% if reste <= 0 %}
                                                    <form method="post" action="{{ path('app_comptable_commande_marquer_paye', {id: cmd.id}) }}" class="d-inline">
                                                        {# On utilise `statutAffiche` pour la condition disabled #}
                                                        <button type="submit" class="btn" {% if statutAffiche == 'PAYE' %}disabled{% endif %}>Payé</button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr><td colspan="8" class="text-center">Aucune commande trouvée.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 2 -->
        <div class="slide" id="2">
            <div class="content third-content">
                <div class="container-fluid">
                    <h2>Procédure d'Arrêt de Caisse</h2>
                    {% if totals is not empty %}
                        <form id="cloture-caisse-form" action="{{ path('app_comptable_arret_de_caisse_submit') }}" method="post">
                            <div class="cloture-form-wrapper">
                                <!--<div class="cloture-form-group">
                                    <label for="fond_de_caisse_initial">Fond de caisse initial (si applicable)</label>
                                    <input type="number" step="0.01" id="fond_de_caisse_initial" name="fond_de_caisse_initial" class="cloture-input" value="0" required>
                                </div>-->

                                <table class="cloture-table">
                                    <thead>
                                        <tr><th>Méthode de Paiement</th><th class="numeric">Total Théorique</th><th>Détail Compté</th><th class="numeric">Écart</th></tr>
                                    </thead>
                                    <tbody>
                                    {% for referencePaiement, theorique in totals %}
                                        <tr>
                                            <td><strong>{{ referencePaiement }}</strong></td>
                                            <td class="numeric" data-theorique="{{ theorique }}">{{ theorique|number_format(0, ',', ' ') }} MGA</td>
                                            <td>
                                                {% if referencePaiement == 'Espèce' %}
                                                    {# === NOUVELLE STRUCTURE POUR LE BILLETAGE === #}
                                                    <div class="billetage-container">
                                                        {% for valeur in [20000, 10000, 5000, 2000, 1000, 500, 200, 100] %}
                                                            <div class="billet-row">
                                                                <span class="billet-label">{{ valeur|number_format(0, ',', ' ') }} MGA x </span>
                                                                <input type="number" name="billet_{{ valeur }}" value="0" class="cloture-input billet-count" min="0" data-valeur="{{ valeur }}">
                                                                <span class="billet-equals"> = </span>
                                                                <span class="billet-subtotal">0 MGA</span>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <input type="number" step="0.01" class="cloture-input amount-counted" name="compte_{{ referencePaiement|lower|replace({' ': '_'}) }}" value="0" required>
                                                {% endif %}
                                            </td>
                                            <td class="numeric ecart">0 MGA</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr style="font-size: 1.2em; background: rgba(0,0,0,0.2);">
                                            <th>Total</th>
                                            <th id="total-theorique" class="numeric">0 MGA</th>
                                            <th id="total-compte" class="numeric">0 MGA</th>
                                            <th id="total-ecart" class="numeric">0 MGA</th>
                                        </tr>
                                    </tfoot>
                                </table>

                                <div class="cloture-form-group" style="margin-top: 30px;">
                                    <label for="notes">Notes sur la clôture (optionnel)</label>
                                    <textarea id="notes" name="notes" class="cloture-textarea" rows="3" placeholder="Ex: écart dû à un rendu de monnaie, etc."></textarea>
                                </div>
                                <button type="submit" class="cloture-submit-btn">Valider et Clôturer la Caisse</button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-info">Aucun paiement à clôturer pour le moment.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Slide 3 (Historique) -->
        <div class="slide" id="3">
             <div class="content fourth-content">
                <div class="container-fluid">
                    <h2 style="color: #fff">Historique des 10 dernières clôtures</h2>
                    <table class="table table-hover">
                        <thead>
                            <tr style="background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">ID</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Date</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Utilisateur</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Écart Espèces</th>
                                <th style="padding: 14px; border: none; font-weight:600; color:#333;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for cloture in pastClotures %}
                            <tr style="background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                                <td style="padding: 12px; border: none;">#{{ cloture.id }}</td>
                                <td style="padding: 12px; border: none;">{{ cloture.dateCloture|date('d/m/Y H:i') }}</td>
                                <td style="padding: 12px; border: none;">{{ cloture.utilisateur.userIdentifier }}</td>
                                {% set ecartEspeces = cloture.detailsPaiements['Espèce'].ecart|default(0) %}
                                <td style="padding: 12px; border: none;" 
                                    class="{% if ecartEspeces < 0 %}text-danger{% elseif ecartEspeces > 0 %}text-warning{% else %}text-success{% endif %}">
                                    {{ ecartEspeces|number_format(0, ',', ' ') }} MGA
                                </td>
                                <td style="padding: 12px; border: none;">
                                    <span class="toggle-btn" 
                                        data-id="{{ cloture.id }}" 
                                        style="cursor:pointer; color:#007bff; font-weight:500;">
                                        Voir détails
                                    </span>
                                </td>
                            </tr>
                            <tr class="details-row" id="details-{{ cloture.id }}">
                                <td colspan="5">
                                    <div style="padding: 15px;">
                                        <h5>Détails de la clôture #{{ cloture.id }}</h5>
                                        <!-- <p><strong>Fond de caisse initial :</strong> {{ cloture.fondDeCaisseInitial|number_format(0, ',', ' ') }} MGA</p> -->
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr style="background: #eee;"><th>Méthode</th><th>Théorique</th><th>Compté</th><th>Écart</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for methode, data in cloture.detailsPaiements %} 
                                                <tr>
                                                    <td><strong>{{ methode }}</strong></td>
                                                    <td>{{ data.theorique|number_format(0, ',', ' ') }} MGA</td>
                                                    <td>{{ data.compte|number_format(0, ',', ' ') }} MGA</td>
                                                    <td>{{ data.ecart|number_format(0, ',', ' ') }} MGA</td>
                                                </tr>
                                                {% if methode == 'Espèce' and data.billetage is defined %}
                                                    <tr>
                                                        <td colspan="4" style="padding-left: 30px;">
                                                            <em>Détail du billetage compté :</em><br>
                                                            {% for val, qte in data.billetage|sort((a, b) => b <=> a) %}
                                                                &bull; {{ val|number_format(0, ',', ' ') }} MGA x {{ qte }} = {{ (val * qte)|number_format(0, ',', ' ') }} MGA<br>
                                                            {% endfor %}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                        {% if cloture.notes %}
                                            <p><strong>Notes :</strong> {{ cloture.notes|nl2br }}</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="5">Aucun historique de clôture.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Slide 4 -->
        <div class="slide" id="4">
            <div class="content fifth-content">
                <div class="container-fluid">
                    <!-- Titre principal -->
                    <h2 style="color: #fff; margin-bottom: 25px;">Gestion</h2>

                    <!-- Container en 2 colonnes -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                        <!-- Colonne 1 : Profil utilisateur -->
                        <div style="background: rgba(255,255,255,0.05); border-radius:12px; 
                                    box-shadow:0 2px 8px rgba(0,0,0,0.2); padding:20px; margin-left:20px;">
                            <h4 style="color:#fff; margin-bottom:15px;">Profil Utilisateur</h4>
                            <p style="color:#fff; margin-bottom:10px;">
                                <strong>Nom :</strong> {{ app.user.userIdentifier }}
                            </p>
                            <p style="color:#fff; margin-bottom:10px;">
                                <strong>Rôle :</strong>
                                {% if 'ROLE_COMPTABLE' in app.user.roles %}
                                    Comptable
                                {% else %}
                                    {{ app.user.roles|join(', ') }}
                                {% endif %}
                            </p>
                        </div>

                        <!-- Colonne 2 : Instructions -->
                        <div style="background: rgba(255,255,255,0.05); border-radius:12px; 
                                    padding:20px; margin-right:20px;">
                            <h4 style="color:#fff; margin-bottom:15px;">Instructions</h4>
                            <ul style="color:#fff; line-height:1.8;">
                                <p>Consultez vos informations de profil (nom, rôle).</p>
                                <p>Utilisez la barre de navigation pour accéder aux autres sections.</p>
                                <p>Vérifiez vos permissions selon votre rôle.</p>
                                <p>Déconnectez-vous en cliquant sur le bouton ci-dessous.</p>
                            </ul>
                        </div>
                    </div>

                    <!-- Bouton Déconnexion (centré sous les colonnes) -->
                    <div style="margin-top:30px; text-align:center;">
                        <a href="{{ path('app_logout') }}" class="btn-gradient" 
                        style="color: #fff; padding:12px 25px; border-radius:8px; text-decoration:none;">
                            <i class="fa fa-sign-out"></i> Déconnexion
                        </a>
                    </div>
                </div>
            </div>
        </div>


    </div>

    {# On inclut jQuery car main.js en dépendait probablement #}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="{{ asset('utils/js_moon/main.js') }}"></script>

    {# === SCRIPT JAVASCRIPT MIS À JOUR === #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR').format(value) + ' MGA';
        }

        function updateAllEcarts() {
            const fondInitial = parseFloat(document.getElementById('fond_de_caisse_initial')?.value) || 0;
            let totalTheo = 0, totalCompte = 0, totalEcart = 0;

            document.querySelectorAll('.cloture-table tbody tr').forEach(row => {
                const theoEl = row.querySelector('[data-theorique]');
                if (!theoEl) return;

                const theo = parseFloat(theoEl.dataset.theorique);
                const ref = row.querySelector('td strong').textContent.trim();
                let compte = 0;

                if (ref === 'Espèce') {
                    // Boucle sur chaque ligne de billet
                    row.querySelectorAll('.billet-row').forEach(billetRow => {
                        const input = billetRow.querySelector('.billet-count');
                        const qte = parseInt(input.value) || 0;
                        const valeur = parseInt(input.dataset.valeur); // On utilise notre data-attribut
                        
                        const subtotal = qte * valeur;
                        
                        // Mise à jour du sous-total de la ligne
                        billetRow.querySelector('.billet-subtotal').textContent = formatCurrency(subtotal);
                        
                        compte += subtotal; // On ajoute au total compté pour les espèces
                    });
                } else {
                    compte = parseFloat(row.querySelector('.amount-counted').value) || 0;
                }

                const ecart = ref === 'Espèce' ? compte - (theo + fondInitial) : compte - theo;
                row.querySelector('.ecart').textContent = formatCurrency(ecart);

                totalTheo += theo;
                totalCompte += compte;
                totalEcart += ecart;
            });

            document.getElementById('total-theorique').textContent = formatCurrency(totalTheo);
            document.getElementById('total-compte').textContent = formatCurrency(totalCompte);
            document.getElementById('total-ecart').textContent = formatCurrency(totalEcart);
        }

        document.body.addEventListener('input', e => {
            if (e.target.classList.contains('amount-counted') || e.target.classList.contains('billet-count') || e.target.id === 'fond_de_caisse_initial') {
                updateAllEcarts();
            }
        });

        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const row = document.getElementById('details-' + btn.dataset.id);
                row.style.display = row.style.display === 'table-row' ? 'none' : 'table-row';
            });
        });
        
        // Lancer un premier calcul au chargement de la page
        updateAllEcarts();
    });
    </script>
</body>
</html>