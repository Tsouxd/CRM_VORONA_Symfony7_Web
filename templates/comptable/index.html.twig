<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Application Comptable - Moonlight</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/fontAwesome.css') }}">
    <link rel="stylesheet" href="{{ asset('utils/css_moon/templatemo-main.css') }}">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800" rel="stylesheet">
    <style>
        /* Styles pour le formulaire dark mode, intégrés ici */
        .cloture-form-wrapper { background: rgba(0, 0, 0, 0.2); padding: 30px; border-radius: 8px; color: #fff; }
        .cloture-form-group { margin-bottom: 25px; }
        .cloture-form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #f0f0f0; }
        .cloture-input, .cloture-textarea { width: 100%; padding: 12px 15px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 5px; color: #fff; font-size: 16px; transition: all 0.3s ease; }
        .cloture-input:focus, .cloture-textarea:focus { outline: none; background-color: rgba(255, 255, 255, 0.15); border-color: #F96D38; }
        .cloture-table { width: 100%; margin-top: 20px; margin-bottom: 20px; border-collapse: collapse; }
        .cloture-table th, .cloture-table td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .cloture-table th { font-weight: 600; text-transform: uppercase; font-size: 12px; color: #ccc; }
        .cloture-table td.numeric { text-align: right; }
        .cloture-table .ecart { font-weight: bold; font-size: 1.1em; }
        .cloture-submit-btn { background-color: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.3s ease; }
        .cloture-submit-btn:hover { background-color: #2ecc71; }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="#1"><i class="fa fa-home"></i> <em>Tableau de bord</em></a></li>
            <li><a href="#2"><i class="fa fa-calculator"></i> <em>Arrêt de Caisse</em></a></li>
            <li><a href="#3"><i class="fa fa-history"></i> <em>Historique</em></a></li>
            <li><a href="#4"><i class="fa fa-cog"></i> <em>Gestion</em></a></li>
        </ul>
    </nav>
    
    <div class="slides">
        <!-- Slide 1: Tableau de bord -->
        <div class="slide" id="1">
            <div class="content first-content">
                <div class="container-fluid">
                    <div class="col-md-3"><div class="author-image"><img src="{{ asset('utils/images_moon/calculator3.png') }}" alt="Comptable"></div></div>
                    <div class="col-md-9">
                        <h2>Arrêt de Caisse</h2>
                        <p>Cette section vous permet de clôturer la caisse pour une journée d'activité. Le processus compare les montants théoriques enregistrés avec les montants comptés physiquement.</p>
                        {% for message in app.flashes('success') %}
                            <div style="background: #27ae60; color: white; padding: 15px; border-radius: 5px; margin-top: 20px;">
                                {{ message }}
                            </div>
                        {% endfor %}
                        {% if hasPaymentsToClose %}
                            <div class="main-btn" style="margin-top: 20px;"><a href="#2">Démarrer l'Arrêt de Caisse</a></div>
                        {% else %}
                            <div style="background: rgba(40, 167, 69, 0.8); color: white; padding: 15px; border-radius: 5px; margin-top: 20px;">
                                <strong>Caisse à jour !</strong> Il n'y a aucun paiement en attente de clôture.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Slide 2: Formulaire d'Arrêt de Caisse -->
        <div class="slide" id="2">
            <div class="content third-content">
                <div class="container-fluid">
                    <h2>Procédure d'Arrêt de Caisse</h2>
                    <p>Veuillez compter physiquement les montants et les saisir ci-dessous.</p>
                    <div class="row">
                        <div class="col-md-12">
                            {% if totals is not empty %}
                            <form id="cloture-caisse-form" action="{{ path('app_comptable_arret_de_caisse_submit') }}" method="post">
                                <div class="cloture-form-wrapper">
                                    <div class="cloture-form-group">
                                        <label for="fond_de_caisse_initial">Fond de caisse initial</label>
                                        <input type="number" step="0.01" id="fond_de_caisse_initial" name="fond_de_caisse_initial" class="cloture-input" required>
                                    </div>
                                    <table class="cloture-table">
                                        <thead><tr><th>Méthode de Paiement</th><th class="numeric">Théorique</th><th>Compté</th><th class="numeric">Écart</th></tr></thead>
                                        <tbody>
                                        {# ✅ ON ITÈRE SUR 'referencePaiement' #}
                                        {% for referencePaiement, theorique in totals %}
                                            <tr>
                                                <td><strong>{{ referencePaiement }}</strong></td>
                                                <td class="numeric" data-theorique="{{ theorique }}">{{ theorique|number_format(0, ',', ' ') }} MGA</td>
                                                {# ✅ LE NOM DU CHAMP EST MAINTENANT CORRECT #}
                                                <td><input type="number" step="0.01" class="cloture-input amount-counted" name="compte_{{ referencePaiement|lower|replace({' ': '_'}) }}" required></td>
                                                <td class="numeric ecart">0 MGA</td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                    <div class="cloture-form-group">
                                        <label for="notes">Notes</label>
                                        <textarea id="notes" name="notes" class="cloture-textarea" rows="3"></textarea>
                                    </div>
                                    <button type="submit" class="cloture-submit-btn">Valider et Clôturer la Caisse</button>
                                </div>
                            </form>
                            {% else %}
                            <div class="alert alert-info" style="background: rgba(23, 162, 184, 0.8); color: white;">
                                Il n'y a aucun paiement à clôturer pour le moment.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Slide 3: Historique des Clôtures -->
        <div class="slide" id="3">
            <div class="content fourth-content">
                <div class="container-fluid">
                    <h2>Historique des 10 dernières clôtures</h2>
                     <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px;">
                        <table class="table table-hover">
                            <thead><tr><th>ID</th><th>Date</th><th>Utilisateur</th><th>Écart Espèces</th><th>Actions</th></tr></thead>
                            <tbody>
                            {% for cloture in pastClotures %}
                                <tr>
                                    <td>#{{ cloture.id }}</td>
                                    <td>{{ cloture.dateCloture|date('d/m/Y H:i') }}</td>
                                    <td>{{ cloture.utilisateur.userIdentifier }}</td>
                                    {% set ecartEspeces = cloture.detailsPaiements['Espèces'].ecart|default(0) %}
                                    <td class="fw-bold {% if ecartEspeces < 0 %}text-danger{% elseif ecartEspeces > 0 %}text-warning{% else %}text-success{% endif %}">
                                        {{ ecartEspeces|number_format(0, ',', ' ') }} MGA
                                    </td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-info">Voir Rapport</a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr><td colspan="5" class="text-center">Aucun historique de clôture.</td></tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Slide 4: Gestion -->
        <div class="slide" id="4">
            <div class="content fifth-content">
                <div class="container-fluid"><div class="col-md-6">
                    <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px;">
                        <h3>Gestion</h3>
                        <a href="{{ path('app_logout') }}" class="btn-gradient">Déconnexion</a>
                    </div>
                </div></div>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="{{ asset('utils/js_moon/main.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Fonction unique pour mettre à jour tous les calculs ---
            function updateAllEcarts() {
                const fondInitialInput = document.getElementById('fond_de_caisse_initial');
                const fondInitial = fondInitialInput ? parseFloat(fondInitialInput.value) || 0 : 0;

                // On boucle sur chaque ligne du tableau
                document.querySelectorAll('.cloture-table tbody tr').forEach(row => {
                    const theoriqueCell = row.querySelector('[data-theorique]');
                    const ecartCell = row.querySelector('.ecart');
                    const countedInput = row.querySelector('.amount-counted');
                    const referencePaiementCell = row.querySelector('td:first-child strong');

                    // Sécurité
                    if (!theoriqueCell || !ecartCell || !countedInput || !referencePaiementCell) return;
                    
                    const theorique = parseFloat(theoriqueCell.dataset.theorique);
                    const compte = parseFloat(countedInput.value) || 0;
                    const referencePaiement = referencePaiementCell.textContent.trim();

                    let ecart;
                    
                    // ✅ LA CORRECTION LOGIQUE EST ICI
                    if (referencePaiement === 'Espèces') {
                        // Pour les espèces, l'écart est la différence entre ce qu'on a compté
                        // et ce qu'on aurait dû avoir (ventes + fond de caisse)
                        ecart = compte - (theorique + fondInitial);
                    } else {
                        // Pour les autres méthodes, l'écart est simple
                        ecart = compte - theorique;
                    }
                    
                    ecartCell.textContent = new Intl.NumberFormat('fr-FR').format(ecart.toFixed(0)) + ' MGA';
                    
                    if (ecart < 0) { ecartCell.style.color = '#e74c3c'; } 
                    else if (ecart > 0) { ecartCell.style.color = '#f39c12'; } 
                    else { ecartCell.style.color = '#2ecc71'; }
                });
            }

            // --- Écouteurs d'événements ---

            // Écouteur pour le calcul en temps réel
            const formContainer = document.querySelector('#cloture-caisse-form');
            if (formContainer) {
                formContainer.addEventListener('input', function(event) {
                    // On recalcule tout si on touche à un champ "compté" OU au fond de caisse
                    if (event.target.classList.contains('amount-counted') || event.target.id === 'fond_de_caisse_initial') {
                        updateAllEcarts();
                    }
                });
            }

            // Écouteur pour la soumission du formulaire (inchangé)
            document.body.addEventListener('submit', function(event) {
                if (event.target && event.target.id === 'cloture-caisse-form') {
                    event.preventDefault();
                    const form = event.target;
                    const formData = new FormData(form);
                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            alert('Une erreur de soumission est survenue.');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Une erreur réseau est survenue.');
                    });
                }
            });
        });
    </script>
</body>
</html>