{# ÉTAPE 1 : On étend le layout principal pour avoir toute la structure #}
{% extends '@EasyAdmin/layout.html.twig' %}

{# ÉTAPE 2 (Optionnel mais propre) : On place le CSS dans le bloc dédié #}
{% block head_stylesheets %}
    {{ parent() }} {# Très important pour ne pas écraser les styles d'EasyAdmin #}
    <style>
      .section-card .card-header h3 { margin:0; font-weight:600; }
    </style>
{% endblock %}

{# ÉTAPE 3 : On place le titre de la page dans son propre bloc #}
{% block content_title %}
    Tableau de bord — Production
{% endblock %}


{# ÉTAPE 4 : On place TOUT le contenu principal dans le bloc 'main' #}
{% block main %}

  {# Section des cartes #}
  <div class="row">
    <div class="col-md-4">
      <div class="card bg-warning text-dark shadow-sm mb-4">
        <div class="card-body">
          <h5>Travaux en attente</h5>
          <p class="h3">{{ worksPendingCount }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-primary text-white shadow-sm mb-4">
        <div class="card-body">
          <h5>Travaux en cours</h5>
          <p class="h3">{{ workInProgressCount }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-success text-white shadow mb-4">
        <div class="card-body">
          <h5>Travaux terminés (aujourd’hui)</h5>
          <p class="h3">{{ workFinishedToday }}</p>
        </div>
      </div>
    </div>
  </div>


  {# Section de la recherche des travaux terminés #}
  <div class="section-card card shadow mb-4">
    <div class="card-header">
      <h3>Rechercher les travaux terminés (prêts pour livraison)</h3>
    </div>
    <div class="card-body">
      {# Formulaire de recherche #}
      <form method="get" action="{{ path('production_dashboard') }}" class="row g-3 align-items-end mb-4 p-3 bg-light-subtle border rounded">
        <div class="col-md-5">
          <label for="date_start" class="form-label">Du</label>
          <input type="date" id="date_start" name="date_start" class="form-control" value="{{ dateStart|date('Y-m-d') }}">
        </div>
        <div class="col-md-5">
          <label for="date_end" class="form-label">Au</label>
          <input type="date" id="date_end" name="date_end" class="form-control" value="{{ dateEnd|date('Y-m-d') }}">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Rechercher</button>
        </div>
      </form>

      {# Tableau des résultats #}
      {% if finishedCommandsInRange is not empty %}
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Client</th>
              <th>Date de fin de production</th>
              <th>Produit(s)</th>
            </tr>
          </thead>
          <tbody>
            {% for cmd in finishedCommandsInRange %}
              <tr>
                <td><a href="{{ ea_url().setController('App\\Controller\\Production\\ProductionCommandeCrudController').setAction('detail').setEntityId(cmd.id) }}">{{ cmd.id }}</a></td>
                <td>{{ cmd.client.nom }}</td>
                <td>{{ cmd.productionStatusUpdatedAt ? cmd.productionStatusUpdatedAt|date('d/m/Y à H:i') : 'N/A' }}</td>
                <td>
                  {% for cp in cmd.commandeProduits %}
                    {{ cp.produit.nom }}{% if not loop.last %}, {% endif %}
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="text-center text-muted mt-3">Aucun travail terminé trouvé pour la période sélectionnée.</p>
      {% endif %}
    </div>
  </div>


  {# Section de l'historique des travaux livrés #}
  <div class="section-card card shadow mb-4">
      <div class="card-header">
          <h3>Historique des travaux livrés</h3>
      </div>
      <div class="card-body">
          {% if deliveredCommands is not empty %}
              <table class="table table-striped table-hover">
                  <thead>
                      <tr>
                          <th>ID</th>
                          <th>Client</th>
                          <th>Date de commande</th>
                          <th>Date de livraison</th>
                          <th>Produit(s)</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for cmd in deliveredCommands %}
                          <tr>
                              <td><a href="{{ ea_url().setController('App\\Controller\\Production\\ProductionCommandeCrudController').setAction('detail').setEntityId(cmd.id) }}">{{ cmd.id }}</a></td>
                              <td>{{ cmd.client.nom }}</td>
                              <td>{{ cmd.dateCommande ? cmd.dateCommande|date('d/m/Y') : '' }}</td>
                              <td>{{ cmd.dateDeLivraison ? cmd.dateDeLivraison|date('d/m/Y') : 'Non définie' }}</td>
                              <td>
                                  {% for cp in cmd.commandeProduits %}
                                      {{ cp.produit.nom }}{% if not loop.last %}, {% endif %}
                                  {% endfor %}
                              </td>
                          </tr>
                      {% endfor %}
                  </tbody>
              </table>
          {% else %}
              <p class="text-muted">Aucun travail livré n’a été trouvé.</p>
          {% endif %}
      </div>
  </div>

{% endblock %}